import Head from "next/head";
import Image from "next/image";
import styles from "../styles/Home.module.css";
import { useState } from "react";
import fetch from "node-fetch";
import {
  SSRProvider,
  DateRangePicker,
  Provider,
  defaultTheme,
  useDateFormatter,
  Button
} from "@adobe/react-spectrum";
import { today } from "@internationalized/date";
import clientPromise from "../mongodb";
import { OptionsPicker } from "../components/OptionsPicker";

export async function getServerSideProps({
  query: { startDate = today(), endDate = today().add({ weeks: 20 }), leagueArr = ["39"] }
}) {
  
  console.log(leagueArr);
  if (typeof(leagueArr) === "string") {
    leagueArr = leagueArr.split(",");
  }
  console.log(leagueArr);
  const league = "41";
  const season = "2022";
  const leagueName = "league-" + league;

  const url =
    "https://api-football-v1.p.rapidapi.com/v3/fixtures?league=" +
    league +
    "&season=" +
    season;

  const options = {
    method: "GET",
    headers: {
      "X-RapidAPI-Key": process.env.API_FOOTBALL_KEY,
      "X-RapidAPI-Host": "api-football-v1.p.rapidapi.com"
    }
  };

  const client = await clientPromise;
  const db = client.db("football_advisor");
  const coll = await db.collection("fixtures");

  if ((await coll.find({ leagueName: leagueName }).count()) === 0) {
    await fetch(url, options)
      .then((res) => res.json())
      .then((json) => {
        console.log("Updating Database...");
        console.log(json);
        const record = {
          leagueName: leagueName,
          dataSet: json.response
        };
        async function insert() {
          if ((await coll.find({ leagueName: leagueName }).count()) === 0) {
            await coll.insert(record);
          }
        }
        insert();
        console.log("Updated.");
      })
      .catch((err) => console.error("error:" + err));
  }

  const rawData = await db
    .collection("fixtures")
    .find({ leagueId: {$in: leagueArr} })
    .toArray();

  let footballData = [];
  let leagueStartDate = new Date("2022-12-01T00:00:00.000Z");
  for (let i = 0; i < rawData.length; i++) {
    for (let j = 0; j < rawData[i].dataSet.length; j++) {
      //console.log(rawData[i].dataSet[j].fixture.date);
      let tempDate = new Date(rawData[i].dataSet[j].fixture.date);
      if (tempDate.getTime() > leagueStartDate.getTime())
        footballData.push(rawData[i].dataSet[j]);
    }
  }

  return {
    props: {
      footballData
    }
  };
}

export default function Home({ footballData }) {
  return (
    <SSRProvider>
      <Provider theme={defaultTheme}>
        <div className={styles.container}>
          <Head>
            <title>Football Advisor</title>
            <meta name="description" content="Generated by create next app" />
            <link rel="icon" href="/favicon.ico" />
          </Head>

          <main className={styles.main}>
            <h1 className={styles.title}>Welcome to Football Advisor</h1>

            <div className={styles.grid}>
              <OptionsPicker/>

              {footballData.map((myItem) => (
                // eslint-disable-next-line react/jsx-key
                <div className={styles.fixture}>
                  <h2>
                    <Image
                      src={myItem.teams.home.logo}
                      layout="fixed"
                      height="100"
                      width="100"
                      alt="Home team logo"
                    />{" "}
                    {myItem.teams.home.name} {myItem.score.fulltime.home} x{" "}
                    {myItem.score.fulltime.away} {myItem.teams.away.name}{" "}
                    <Image
                      src={myItem.teams.away.logo}
                      layout="fixed"
                      height="100"
                      width="100"
                      alt="away team logo"
                    />
                  </h2>
                  <h3>{myItem.fixture.date}</h3>
                  <h3>
                    {myItem.fixture.venue.name} ({myItem.fixture.venue.city})
                  </h3>
                  <div>
                    <Image
                      src={myItem.league.logo}
                      layout="fixed"
                      height="50"
                      width="50"
                      alt="league logo"
                    />
                    {myItem.league.name} ({myItem.league.country}) :{" "}
                    {myItem.league.round}
                  </div>
                  <h4></h4>
                </div>
              ))}
            </div>
          </main>

          <footer className={styles.footer}>
            <a
              href="https://vercel.com?utm_source=create-next-app&utm_medium=default-template&utm_campaign=create-next-app"
              target="_blank"
              rel="noopener noreferrer"
            >
              Powered by{" "}
              <span className={styles.logo}>
                <Image
                  src="/vercel.svg"
                  alt="Vercel Logo"
                  width={72}
                  height={16}
                />
              </span>
            </a>
          </footer>
        </div>
      </Provider>
    </SSRProvider>
  );
}
